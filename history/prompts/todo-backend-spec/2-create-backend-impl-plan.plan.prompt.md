---
id: 2
title: create-backend-impl-plan
stage: plan
date_iso: 2026-02-07
surface: agent
model: Qwen
feature: todo-backend-fastapi-neon-phase2
branch: 003-todo-backend-spec
user: user
command: /sp.plan
labels:
  - backend
  - plan
  - fastapi
  - todo
  - neon
links:
  spec: ../003-todo-backend-spec/spec.md
  ticket: null
  adr: null
  pr: null
files_yaml:
  - D:\Todo Hackathon\Phase 2\specs\003-todo-backend-spec\plan.md
  - D:\Todo Hackathon\Phase 2\specs\003-todo-backend-spec\research.md
  - D:\Todo Hackathon\Phase 2\specs\003-todo-backend-spec\data-model.md
  - D:\Todo Hackathon\Phase 2\specs\003-todo-backend-spec\quickstart.md
  - D:\Todo Hackathon\Phase 2\specs\003-todo-backend-spec\contracts\todo-api.yaml
tests_yaml: []
prompt_text: "$ARGUMENTS\n\nExecute the implementation planning workflow using the plan template to generate design artifacts.\n\n## User Input\n\n```text\n$ARGUMENTS\n```\n\nYou **MUST** consider the user input before proceeding (if not empty).\n\n## Outline\n\n1. **Setup**: Run `.specify/scripts/powershell/setup-plan.ps1 -Json` from repo root and parse JSON for FEATURE_SPEC, IMPL_PLAN, SPECS_DIR, BRANCH. For single quotes in args like \"I'm Groot\", use escape syntax: e.g 'I'\\''m Groot' (or double-quote if possible: \"I'm Groot\").\n\n2. **Load context**: Read FEATURE_SPEC and `.specify/memory/constitution.md`. Load IMPL_PLAN template (already copied).\n\n3. **Execute plan workflow**: Follow the structure in IMPL_PLAN template to:\n   - Fill Technical Context (mark unknowns as \"NEEDS CLARIFICATION\")\n   - Fill Constitution Check section from constitution\n   - Evaluate gates (ERROR if violations unjustified)\n   - Phase 0: Generate research.md (resolve all NEEDS CLARIFICATION)\n   - Phase 1: Generate data-model.md, contracts/, quickstart.md\n   - Phase 1: Update agent context by running the agent script\n   - Re-evaluate Constitution Check post-design\n\n4. **Stop and report**: Command ends after Phase 2 planning. Report branch, IMPL_PLAN path, and generated artifacts.\n\n## Phases\n\n### Phase 0: Outline & Research\n\n1. **Extract unknowns from Technical Context** above:\n   - For each NEEDS CLARIFICATION → research task\n   - For each dependency → best practices task\n   - For each integration → patterns task\n\n2. **Generate and dispatch research agents**:\n\n   ```text\n   For each unknown in Technical Context:\n     Task: \"Research {unknown} for {feature context}\"\n   For each technology choice:\n     Task: \"Find best practices for {tech} in {domain}\"\n   ```\n\n3. **Consolidate findings** in `research.md` using format:\n   - Decision: [what was chosen]\n   - Rationale: [why chosen]\n   - Alternatives considered: [what else evaluated]\n\n**Output**: research.md with all NEEDS CLARIFICATION resolved\n\n### Phase 1: Design & Contracts\n\n**Prerequisites:** `research.md` complete\n\n1. **Extract entities from feature spec** → `data-model.md`:\n   - Entity name, fields, relationships\n   - Validation rules from requirements\n   - State transitions if applicable\n\n2. **Generate API contracts** from functional requirements:\n   - For each user action → endpoint\n   - Use standard REST/GraphQL patterns\n   - Output OpenAPI/GraphQL schema to `/contracts/`\n\n3. **Agent context update**:\n   - Run `.specify/scripts/powershell/update-agent-context.ps1 -AgentType qwen`\n   - These scripts detect which AI agent is in use\n   - Update the appropriate agent-specific context file\n   - Add only new technology from current plan\n   - Preserve manual additions between markers\n\n**Output**: data-model.md, /contracts/*, quickstart.md, agent-specific file\n\n## Key rules\n\n- Use absolute paths\n- ERROR on gate failures or unresolved clarifications\n\n---\n\n/sp.plan /sp.plan\n\nCreate a highly detailed, refined technical implementation plan **exclusively for the backend** of the Todo Full-Stack Web Application (Phase 2). This plan must ensure that **all backend-related code, configuration, and logic lives inside a single, self-contained backend/ folder**, with zero leakage to frontend or root level. The backend must be fully implementable, testable independently, and ready for seamless integration with the frontend via REST API.\n\nStrictly follow the constitution and the backend specification that was just generated.\n\nProject Context & Constraints:\n- Backend folder: backend/ (isolated – main.py, models, routes, etc. sab yahin rahenge)\n- Tech: FastAPI (async), SQLModel, Neon PostgreSQL\n- Env vars (use exactly these values in plan descriptions):\n  - BETTER_AUTH_SECRET=70tvEiM4SIXNZegpxN5TQRvMiUGePVwU\n  - DATABASE_URL=postgresql://neondb_owner:npg_8USzj6FdhfkE@ep-delicate-credit-airvucw7-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require\n- Frontend calls: http://localhost:8000/api/tasks with header Authorization: Bearer <token>\n- No frontend code, no Next.js references beyond API contract compatibility\n\nKey Technical Decisions & Tradeoffs (refined & explicit):\n\n1. Project Isolation\n   - All backend code, deps, env handling inside backend/\n   - Run command: cd backend && uvicorn main:app --reload --port 8000\n   - Chosen: Strict folder isolation for clean monorepo\n\n2. JWT Verification Method\n   - Manual PyJWT decode in dependency (no third-party auth lib)\n   - Reason: Minimal deps, full control, hackathon-friendly\n\n3. Database Setup\n   - Async engine + AsyncSession\n   - Table creation: metadata.create_all() on startup (no Alembic for speed)\n   - Reason: Simple, works with Neon serverless\n\n4. API Router & Organization\n   - APIRouter(prefix=\"/api/tasks\") in routes/tasks.py\n   - Dependencies injected via Depends()\n\n5. Response Models\n   - TaskRead excludes user_id (security)\n   - Timestamps serialized as ISO strings\n\n6. CORS\n   - Allow origin: http://localhost:3000 (frontend)\n   - Methods: GET, POST, PUT, DELETE, PATCH, OPTIONS\n\n7. Error Standardization\n   - All errors return JSON {\"detail\": str, \"code\": optional}\n   - 401 for auth, 403 for ownership, 404 not found, 422 validation\n\nArchitecture Sketch (Backend Folder Only):\nbackend/\n├── main.py                  # App entry, CORS, startup event, router include\n├── models.py                # SQLModel Task class\n├── schemas.py               # Pydantic: TaskCreate, TaskUpdate, TaskRead\n├── dependencies.py          # get_db(), get_current_user()\n├── auth.py                  # JWT decode + verification logic\n├── routes/\n│   └── tasks.py             # All endpoints + ownership checks\n├── db.py                    # engine, session factory, init_db()\n├── .env                     # Optional – or use os.getenv in code\n└── requirements.txt         # fastapi, uvicorn, sqlmodel, python-jose[cryptography]\n\nProposed Backend Structure (detailed):\n- main.py: FastAPI(), add CORS, @app.on_event(\"startup\") async def startup(): await init_db(), app.include_router(tasks_router)\n- models.py: class Task(SQLModel, table=True): id: int | None = Field(default=None, primary_key=True), user_id: str, ...\n- schemas.py: class TaskCreate(BaseModel): title: str, description: str | None = None\n- dependencies.py: async def get_db(): ..., async def get_current_user(...): ...\n- auth.py: def verify_jwt(token: str) -> dict: ... (jwt.decode(...))\n- routes/tasks.py: router = APIRouter(...), @router.get(\"/\") async def list_tasks(current_user=Depends(get_current_user), db=Depends(get_db)): ...\n\nQuality & Validation Strategy:\n- Independent backend testing:\n  - uvicorn → http://localhost:8000/docs (Swagger UI)\n  - curl -H \"Authorization: Bearer <valid-jwt>\" http://localhost:8000/api/tasks\n  - Test ownership: Create task with token A, try delete with token B → 403\n  - Neon connection: Startup log should show no connection error\n- Edge cases checklist:\n  - Empty list → []\n  - Invalid token → 401\n  - Missing title on POST → 422\n  - Non-existent ID → 404\n  - Ownership violation → 403\n\nImplementation Roadmap (refined sequential phases – all inside backend/):\n1. Create backend/ folder + requirements.txt + .env.example\n2. Setup db.py: async engine, get_session dependency\n3. Create models.py: Task SQLModel class\n4. Create schemas.py: Pydantic models for create/update/read\n5. Create auth.py: JWT verification function\n6. Create dependencies.py: get_current_user + get_db\n7. Create routes/tasks.py: APIRouter + all 6 endpoints with ownership checks\n8. Create main.py: FastAPI app, CORS, startup event (init_db), include_router\n9. Add global exception handler for JWT errors\n10. Add basic logging (print or logging module) for startup & errors\n11. Test locally: cd backend && uvicorn main:app --reload\n12. Integration verification: Ensure JSON responses match frontend types (id int, completed bool, dates ISO)\n\nRisks & Mitigations:\n- Neon connection fail → Check URL, SSL params, firewall\n- JWT secret mismatch → Use exact value from constitution\n- Async session leak → Use async with AsyncSession(db) as session:\n- CORS error → Explicitly allow frontend origin\n\nOutput Format (clean Markdown):\n- # Technical Plan: backend-fastapi-neon-phase2 (Refined)\n- ## Backend Isolation & Folder Structure\n- ## Refined Technical Decisions & Tradeoffs\n- ## Detailed File-by-File Architecture\n- ## JWT Verification & Dependencies\n- ## Database Setup & Neon Integration\n- ## API Endpoints Step-by-Step Plan\n- ## Security, Errors & CORS\n- ## Frontend API Contract (response shapes)\n- ## Quality, Testing & Validation Checklist\n- ## Implementation Roadmap (12 phases)\n- ## Risks, Mitigations & Env Vars Usage\n\nDo NOT generate any code yet – only this refined plan.\nAll backend work must stay inside backend/ folder.\nAfter plan approval, next step: /sp.tasks for backend implementation."
response_text: "I have successfully created a detailed technical implementation plan for the backend of the Todo application. The plan includes all required sections: backend isolation, technical decisions, file-by-file architecture, JWT verification details, database setup, API endpoints, security considerations, API contract, quality validation, implementation roadmap, and risk mitigation. Additionally, I've created the following artifacts: research.md, data-model.md, quickstart.md, and an OpenAPI contract in the contracts/ directory. The agent context has been updated with the new technology information. The plan is comprehensive and ready for the next phase (/sp.tasks) where implementation tasks will be broken down."
outcome_evaluation: "The implementation plan has been successfully created with all required sections and supporting artifacts. The plan follows the constitution and backend specification, ensuring all backend code will be contained within the backend/ directory. All technical decisions are documented with rationale, and the implementation roadmap is clearly outlined in 12 phases."
evaluation_details: "All required deliverables were created: plan.md, research.md, data-model.md, quickstart.md, and contracts/todo-api.yaml. The constitution check was performed and passed. The agent context was updated with new technology information. The plan is comprehensive and ready for the next phase."
---